<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ollama MCP Chat</title>
<style>
body {
    font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
    background: #fff8f0; /* æ˜ã‚‹ã„ãƒ‘ã‚¹ãƒ†ãƒ«èƒŒæ™¯ */
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    margin: 0;
    padding: 0;
}

h2 {
    margin: 20px 0;
    color: #ff7f50; /* ãƒãƒƒãƒ—ãªã‚ªãƒ¬ãƒ³ã‚¸ */
    text-shadow: 1px 1px 2px #ffd2b3;
}

#chat-container {
    flex: 1;
    width: 90%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    border: 2px solid #ffd2b3;
    border-radius: 20px;
    background: #fff0e6;
    padding: 15px;
    overflow-y: auto;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
}

.message {
    padding: 10px 15px;
    margin: 5px 0;
    border-radius: 20px;
    max-width: 70%;
    word-wrap: break-word;
    line-height: 1.4;
    font-size: 16px;
    transition: all 0.2s;
    white-space: pre-wrap;
}

.user {
    background: #ffd1dc; /* ãƒ”ãƒ³ã‚¯ç³» */
    align-self: flex-end;
    color: #333;
    border-bottom-right-radius: 0;
}

.ai {
    background: #b3e5fc; /* æ°´è‰²ç³» */
    align-self: flex-start;
    color: #333;
    border-bottom-left-radius: 0;
}

#input-container {
    display: flex;
    width: 90%;
    max-width: 700px;
    margin: 10px 0 20px;
}

#msg {
    flex: 1;
    padding: 10px 15px;
    border-radius: 25px;
    border: 2px solid #ffd2b3;
    background: #fff;
    color: #333;
    font-size: 16px;
    outline: none;
}

#send-btn {
    margin-left: 10px;
    padding: 0 20px;
    border-radius: 25px;
    border: none;
    background: #ffb347; /* æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

#send-btn:hover {
    background: #ffa500;
    transform: scale(1.05);
}

.thinking {
    font-style: italic;
    opacity: 0.7;
    animation: thinkingDots 1.5s infinite;
}

@keyframes thinkingDots {
    0%   { content: "è€ƒãˆä¸­"; }
    33%  { content: "è€ƒãˆä¸­."; }
    66%  { content: "è€ƒãˆä¸­.."; }
    100% { content: "è€ƒãˆä¸­..."; }
}
</style>
<link rel="icon" href="data:,">
</head>
<body>
<h2>Ollama MCP Chat ğŸ’¬</h2>
<div id="chat-container"></div>

<div id="input-container">
    <input type="text" id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
    <button id="send-btn">é€ä¿¡</button>
</div>

<script>
const USER_ID = 'user_' + Math.random().toString(36).substring(2, 10);

function renderLiteMarkdown(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/^- (.+)$/gm, "<li>$1</li>")
        .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")
}

async function sendMessage() {
    const input = document.getElementById("msg");
    const chat = document.getElementById("chat-container");
    const userText = input.value.trim();
    if (!userText) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã—
    chat.innerHTML += `<div class="message user">${userText}</div>`;

    // AIå¹ãå‡ºã—
    const aiDiv = document.createElement("div");
    aiDiv.className = "message ai";
    aiDiv.textContent = "è€ƒãˆä¸­";
    chat.appendChild(aiDiv);

    // è€ƒãˆä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let dots = 0;
    const thinkingTimer = setInterval(() => {
        dots = (dots + 1) % 4;
        aiDiv.textContent = "è€ƒãˆä¸­" + ".".repeat(dots);
    }, 500);

    input.value = '';
    chat.scrollTop = chat.scrollHeight;

    const response = await fetch("/chat/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ user_id: USER_ID, message: userText })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    let buffer = "";
    let skipState = 3;
    let started = false;

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split("\n\n");
        buffer = parts.pop();

        for (const part of parts) {
            if (!part.startsWith("data: ")) continue;

            const data = part.replace("data: ", "");
            if (data === "[DONE]") {
                clearInterval(thinkingTimer);
                return;
            }

            const text = JSON.parse(data);

            if (skipState > 0) {
                const trimmed = text.trim();
                if (
                    trimmed.startsWith("```") ||
                    trimmed.startsWith("xml") ||
                    trimmed === ""
                ) {
                    skipState--;
                    continue;
                } else {
                    skipState = 0;
                }
            }

            if (!started) {
                started = true;
                clearInterval(thinkingTimer);
                aiDiv.textContent = "";
            }

            aiDiv.textContent += renderLiteMarkdown(text);
            chat.scrollTop = chat.scrollHeight;
        }
    }
}

// Enterã‚­ãƒ¼ã§é€ä¿¡
document.getElementById("msg").addEventListener("keypress", function(e) {
    if (e.key === "Enter") sendMessage();
});

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é€ä¿¡
document.getElementById("send-btn").addEventListener("click", sendMessage);
</script>
</body>
</html>
